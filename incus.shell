#!/bin/bash
set -euo pipefail

CONTAINER="${1:-${CLAUDE_CONTAINER:-}}"

if [[ -z "$CONTAINER" ]]; then
  echo "Usage: $(basename "$0") <container> [command...]"
  exit 1
fi

HOST_USER="$(id -un)"

if [[ $# -gt 1 ]]; then
  shift
  # printf %q safely escapes the command string for the su -c -> zsh -ic chain.
  # Embedded quotes in individual args won't round-trip perfectly â€” open a shell
  # for anything complex.
  exec incus exec "$CONTAINER" -- \
    su - "$HOST_USER" -c "cd /workspace && exec zsh -ic $(printf '%q' "$*")"
else
  exec incus exec "$CONTAINER" -- su - "$HOST_USER"
fi
